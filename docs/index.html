<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riada Pamplona — Visualización</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2c;
      --text:#e8eefc;
      --muted:#a9b7d6;
      --border:rgba(255,255,255,.10);
      --accent:#6ea8ff;
      --ok:#34d399;
      --bad:#fb7185;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#070b14 0%,var(--bg) 100%);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }
    h1{
      margin:18px 16px 6px;
      font-size:22px;
      text-align:center;
    }
    .subtitle{
      margin:0 16px 14px;
      color:var(--muted);
      max-width:960px;
      text-align:center;
      line-height:1.35;
      font-size:13px;
    }

    #slide-wrapper{
      position:relative;
      width:92%;
      max-width:1100px;
      margin: 10px auto 18px;
      background: rgba(18,26,44,.75);
      border:1px solid var(--border);
      box-shadow: 0 2px 14px rgba(0,0,0,.35);
      border-radius:16px;
      overflow:hidden;
      backdrop-filter: blur(6px);
    }

    #topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    #slideTitle{
      font-weight:800;
      font-size:14px;
    }
    #slideCounter{
      color:var(--muted);
      font-variant-numeric:tabular-nums;
      font-size:12px;
      white-space:nowrap;
    }

    #slide-container{
      width:100%;
      text-align:center;
    }

    /* responsive area */
    .frame{
      width:100%;
      height: 660px;
      border:0;
      display:block;
      background: rgba(255,255,255,.02);
    }
    .img{
      max-width:100%;
      height:auto;
      display:block;
      margin:0 auto;
      background: rgba(255,255,255,.02);
    }

    #controls{
      position:absolute;
      top:50%;
      width:100%;
      display:flex;
      justify-content:space-between;
      transform:translateY(-50%);
      pointer-events:none;
    }
    .control-button{
      pointer-events:auto;
      background: rgba(255,255,255,0.75);
      border:1px solid rgba(0,0,0,.06);
      font-size:2rem;
      padding:8px 18px;
      cursor:pointer;
      user-select:none;
      border-radius:14px;
      margin:0 8px;
    }
    .control-button:hover{
      background: rgba(255,255,255,0.92);
    }

    footer{
      margin:0 16px 18px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
      max-width:960px;
      line-height:1.35;
    }

    /* ----- SIMULADOR (slide final) ----- */
    .sim-wrap{
      padding:16px;
      text-align:left;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr;}
      .frame{height:560px;}
    }
    .card{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:10px 0;
    }
    .label{font-weight:800;}
    .small{color:var(--muted);font-size:13px;}
    input[type="range"]{width:100%; accent-color: var(--accent);}
    .pill{
      min-width:92px;
      text-align:right;
      font-variant-numeric:tabular-nums;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
    }
    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .kpi > div{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
    }
    .kpi .k{color:var(--muted);font-size:12px;margin-bottom:6px;}
    .kpi .v{font-size:20px;font-weight:900;font-variant-numeric:tabular-nums;}
    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-weight:900;
      margin-top:10px;
      width:fit-content;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background:var(--ok);
      box-shadow:0 0 0 4px rgba(52,211,153,.18);
    }
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button.smallbtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    button.smallbtn:hover{background:rgba(255,255,255,.10);}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      width:fit-content;
      margin-top:10px;
    }
    .badge b{color:var(--text);}
  </style>
</head>

<body>
  <h1>Riada Pamplona — Visualización interactiva</h1>
  <p class="subtitle">
    Navega con ◀ ▶ para recorrer la historia: series temporales, retardos/correlación y, al final, un simulador con umbral y mapa de zonas inundables.
  </p>

  <div id="slide-wrapper">
    <div id="topbar">
      <div id="slideTitle">—</div>
      <div id="slideCounter">—</div>
    </div>

    <div id="slide-container"></div>

    <div id="controls">
      <button class="control-button" id="prevBtn">&#9664;</button>
      <button class="control-button" id="nextBtn">&#9654;</button>
    </div>
  </div>

  <footer>
    • Teclas: <b>←</b> y <b>→</b> • En gráficos Plotly puedes hacer zoom y pan • En el simulador se activa “INUNDACIÓN” si Pamplona (estimado) supera el umbral.
  </footer>

<script>
  // ======================
  // 1) SLIDES 
  // ======================
  const slides = [
    { type: 'img', title: 'Portada', src: 'plots/noticia.png' },

    // Ejemplos: pon aquí tus plotly exportados
    { type: 'iframe', title: 'Series temporales — caudal durante la inundación', src: 'src/caudal_inun.html' },
    { type: 'iframe', title: 'Series temporales — caudal por estación', src: 'src/caudal.html' },
    <!-- { type: 'iframe', title: 'Retardos — correlación por lag', src: 'src/heatmap.html' }, -->
    { type: 'iframe', title: 'Predicción — A313 real vs predicho', src: 'src/prediccion_caudal.html' },

    // Última slide: simulador
    { type: 'simulator', title: 'Simulador + mapa de zonas inundables' }
  ];

  let current = 0;

  const container = document.getElementById('slide-container');
  const slideTitle = document.getElementById('slideTitle');
  const slideCounter = document.getElementById('slideCounter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  function showSlide(index){
    current = Math.max(0, Math.min(slides.length - 1, index));
    const slide = slides[current];

    slideTitle.textContent = slide.title || `Slide ${current+1}`;
    slideCounter.textContent = `${current+1} / ${slides.length}`;

    prevBtn.disabled = current === 0;
    nextBtn.disabled = current === slides.length - 1;

    if(slide.type === 'img'){
      container.innerHTML = `<img class="img" src="${slide.src}" alt="${slide.title || 'Figura'}">`;
    } else if(slide.type === 'iframe'){
      container.innerHTML = `<iframe class="frame" src="${slide.src}"></iframe>`;
    } else if(slide.type === 'simulator'){
      container.innerHTML = simulatorHTML();
      // Inicializar lógica del simulador
      initSimulator();
    } else {
      container.innerHTML = `<div style="padding:18px;color:var(--muted)">Slide no reconocida</div>`;
    }
  }

  function nextSlide(){ showSlide(current + 1); }
  function prevSlide(){ showSlide(current - 1); }

  prevBtn.addEventListener('click', prevSlide);
  nextBtn.addEventListener('click', nextSlide);

  window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft') prevSlide();
    if(e.key === 'ArrowRight') nextSlide();
  });

  // ======================
  // 2) SIMULATOR (HTML)
  // ======================
  function simulatorHTML(){
    return `
      <div class="sim-wrap">
        <div class="grid">
          <section class="card">
            <div class="label">Simulador de caudal aguas arriba → Pamplona</div>
            <div class="small" style="margin-top:6px;">
              Pamplona (estimado) se calcula con un modelo cargado desde <code>model.json</code>. Si no carga, se usa fallback a suma.
            </div>
            <div class="badge" id="modelBadge">Modelo: <b>Cargando…</b></div>

            <div class="row" style="margin-top:14px;">
              <div><div class="label">A067</div><div class="small">Caudal (m³/s)</div></div>
              <div class="pill" id="v067">0</div>
            </div>
            <input id="s067" type="range" min="0" max="300" step="1" value="50" />

            <div class="row">
              <div><div class="label">A152</div><div class="small">Caudal (m³/s)</div></div>
              <div class="pill" id="v152">0</div>
            </div>
            <input id="s152" type="range" min="0" max="300" step="1" value="60" />

            <div class="row">
              <div><div class="label">A159</div><div class="small">Caudal (m³/s)</div></div>
              <div class="pill" id="v159">0</div>
            </div>
            <input id="s159" type="range" min="0" max="300" step="1" value="70" />

            <div class="kpi">
              <div><div class="k">Suma aguas arriba</div><div class="v" id="sumUp">0</div></div>
              <div><div class="k">Pamplona (estimado)</div><div class="v" id="sumPam">0</div></div>
            </div>

            <div class="row" style="margin-top: 12px;">
              <div><div class="label">Umbral de inundación</div><div class="small">INUNDACIÓN si Pamplona &gt; umbral</div></div>
              <div class="pill" id="thrText">200</div>
            </div>
            <input id="thr" type="range" min="50" max="600" step="10" value="200" />

            <div class="status" id="status">
              <span class="dot" id="dot"></span>
              <span id="statusText">NORMAL</span>
            </div>

            <div class="btnrow">
              <button class="smallbtn" id="reset">Reset</button>
              <button class="smallbtn" id="exampleFlood">Ejemplo inundación</button>
              <button class="smallbtn" id="exampleNormal">Ejemplo normal</button>
            </div>

            <div class="foot">
              Requisito: <code>model.json</code> y <code>mapa_folium_api.html</code> deben estar en la misma carpeta que este <code>index.html</code> (docs/).
            </div>
          </section>

          <section class="card">
            <div class="label">Mapa</div>
            <div class="small">Zonas inundables se encienden/apagan según el estado</div>

            <div class="imgbox" style="height:640px;">
              <iframe class="frame" id="mapFrame" src="src/mapa_folium_api.html" style="height:640px;"></iframe>
            </div>

            <div class="foot">Zonas inundables de Pamplona.</div>
          </section>
        </div>
      </div>
    `;
  }

  // ======================
  // 3) SIMULATOR (JS)
  // ======================
  function initSimulator(){
    const s067 = document.getElementById("s067");
    const s152 = document.getElementById("s152");
    const s159 = document.getElementById("s159");
    const thr  = document.getElementById("thr");

    const v067 = document.getElementById("v067");
    const v152 = document.getElementById("v152");
    const v159 = document.getElementById("v159");

    const sumUp  = document.getElementById("sumUp");
    const sumPam = document.getElementById("sumPam");
    const thrText = document.getElementById("thrText");

    const dot = document.getElementById("dot");
    const statusText = document.getElementById("statusText");

    const resetBtn = document.getElementById("reset");
    const exFlood = document.getElementById("exampleFlood");
    const exNormal = document.getElementById("exampleNormal");

    const mapFrame = document.getElementById("mapFrame");
    const modelBadge = document.getElementById("modelBadge");

    let mapReady = false;
    let MODEL = null;

    function fmt(x){ return Number(x).toFixed(0); }

    async function loadModel(){
      try{
        const res = await fetch("model.json", { cache: "no-cache" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        MODEL = await res.json();
        const feats = (MODEL.features || []).join(", ");
        modelBadge.innerHTML = `Modelo: <b>OK</b> <span style="opacity:.7;">(${feats || "Ridge"})</span>`;
        update();
      }catch(e){
        console.warn("No se pudo cargar model.json. Fallback a suma.", e);
        MODEL = null;
        modelBadge.innerHTML = `Modelo: <b>FALLBACK</b> <span style="opacity:.7;">(suma)</span>`;
        update();
      }
    }

    function predictPamplona(a067, a152, a159){
      if(!MODEL) return a067 + a152 + a159;

      const mean = MODEL.scaler?.mean;
      const scale = MODEL.scaler?.scale;
      const coef = MODEL.ridge?.coef;
      const intercept = MODEL.ridge?.intercept;

      if(!mean || !scale || !coef || (intercept === undefined || intercept === null)){
        return a067 + a152 + a159;
      }

      const x = [a067, a152, a159];
      const xz = x.map((v,i) => (v - mean[i]) / scale[i]);

      let yhat = intercept;
      for(let i=0;i<coef.length;i++) yhat += coef[i] * xz[i];

      if(!Number.isFinite(yhat)) yhat = a067 + a152 + a159;
      return Math.max(0, yhat);
    }

    function toggleInundables(visible){
      if(!mapReady) return;

      let tries = 0;
      const maxTries = 20;
      const interval = 100;

      const timer = setInterval(() => {
        tries++;
        try{
          const w = mapFrame.contentWindow;
          if (w && typeof w.setLayerVisible === "function") {
            w.setLayerVisible("Zonas inundables", visible);
            setTimeout(() => {
              try { w.setLayerVisible("Zonas inundables", visible); } catch(e){}
            }, 150);
            clearInterval(timer);
          }
        }catch(e){}
        if(tries >= maxTries) clearInterval(timer);
      }, interval);
    }

    mapFrame.addEventListener("load", () => {
      const t = setInterval(() => {
        try{
          const w = mapFrame.contentWindow;
          if (w && typeof w.setLayerVisible === "function") {
            mapReady = true;
            clearInterval(t);
            update();
          }
        }catch(e){}
      }, 50);
    });

    function setFloodUI(flood){
      // postMessage extra por robustez
      if (mapFrame && mapFrame.contentWindow) {
        mapFrame.contentWindow.postMessage({
          type: "setLayerVisible",
          name: "Zonas inundables",
          visible: flood
        }, "*");
      }

      if (flood) {
        statusText.textContent = "INUNDACIÓN";
        dot.style.background = "var(--bad)";
        dot.style.boxShadow = "0 0 0 4px rgba(251,113,133,.18)";
      } else {
        statusText.textContent = "NORMAL";
        dot.style.background = "var(--ok)";
        dot.style.boxShadow = "0 0 0 4px rgba(52,211,153,.18)";
      }
    }

    function update(){
      const a067 = Number(s067.value);
      const a152 = Number(s152.value);
      const a159 = Number(s159.value);
      const threshold = Number(thr.value);

      v067.textContent = fmt(a067);
      v152.textContent = fmt(a152);
      v159.textContent = fmt(a159);

      const sum = a067 + a152 + a159;
      sumUp.textContent = fmt(sum);

      // ✅ Pamplona estimado = modelo
      const pam = predictPamplona(a067, a152, a159);
      sumPam.textContent = fmt(pam);

      thrText.textContent = fmt(threshold);

      const flood = pam > threshold;
      toggleInundables(flood);
      setFloodUI(flood);
    }

    [s067, s152, s159, thr].forEach(el => el.addEventListener("input", update));

    resetBtn.addEventListener("click", () => { s067.value=50; s152.value=60; s159.value=70; thr.value=200; update(); });
    exFlood.addEventListener("click", () => { s067.value=120; s152.value=120; s159.value=120; thr.value=200; update(); });
    exNormal.addEventListener("click", () => { s067.value=30; s152.value=40; s159.value=35; thr.value=200; update(); });

    update();
    loadModel();
  }

  // Init
  window.onload = () => showSlide(0);
</script>
</body>
</html>
